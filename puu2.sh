#!/bin/bash
#Written by Kevin Ross (kmross)

#########################################################################
# Password Upload Utility v2 - Linux
# 
# Description:  Updated Password Upload Utility utilizing the REST API
#               instead of an outdated and restricted version of PACLI
#
# Created by:   Kevin Ross (kmross)
#
# 
################## WELCOME TO CYBERARK IMPACT 2017! #####################
#
# TODO:         Hire a real pl/py coder instead :-)
#               Get InfamousJoeG Drunk
#               Add Bulk Change Method
#               Add Additional Properties for non-Windows account
#               Safe Verification
#               Platform Verification
#               Error Handling Everywhere in the script
#               Parse logs from curl for error checking
#               Add logging to file
#
#########################################################################

#printf "\n            PUU2"
#printf "\n\n"
#printf "\n░░░░░░░░░▄░░░░░░░░░░░░░░▄░░░░"
#printf "\n░░░░░░░░▌▒█░░░░░░░░░░░▄▀▒▌░░░"
#printf "\n░░░░░░░░▌▒▒█░░░░░░░░▄▀▒▒▒▐░░░"
#printf "\n░░░░░░░▐▄▀▒▒▀▀▀▀▄▄▄▀▒▒▒▒▒▐░░░"
#printf "\n░░░░░▄▄▀▒░▒▒▒▒▒▒▒▒▒█▒▒▄█▒▐░░░"
#printf "\n░░░▄▀▒▒▒░░░▒▒▒░░░▒▒▒▀██▀▒▌░░░"
#printf "\n░░▐▒▒▒▄▄▒▒▒▒░░░▒▒▒▒▒▒▒▀▄▒▒▌░░"
#printf "\n░░▌░░▌█▀▒▒▒▒▒▄▀█▄▒▒▒▒▒▒▒█▒▐░░"
#printf "\n░▐░░░▒▒▒▒▒▒▒▒▌██▀▒▒░░░▒▒▒▀▄▌░"
#printf "\n░▌░▒▄██▄▒▒▒▒▒▒▒▒▒░░░░░░▒▒▒▒▌░"
#printf "\n▀▒▀▐▄█▄█▌▄░▀▒▒░░░░░░░░░░▒▒▒▐░"
#printf "\n▐▒▒▐▀▐▀▒░▄▄▒▄▒▒▒▒▒▒░▒░▒░▒▒▒▒▌"
#printf "\n▐▒▒▒▀▀▄▄▒▒▒▄▒▒▒▒▒▒▒▒░▒░▒░▒▒▐░"
#printf "\n░▌▒▒▒▒▒▒▀▀▀▒▒▒▒▒▒░▒░▒░▒░▒▒▒▌░"
#printf "\n░▐▒▒▒▒▒▒▒▒▒▒▒▒▒▒░▒░▒░▒▒▄▒▒▐░░"
#printf "\n░░▀▄▒▒▒▒▒▒▒▒▒▒▒░▒░▒░▒▄▒▒▒▒▌░░"
#printf "\n░░░░▀▄▒▒▒▒▒▒▒▒▒▒▄▄▄▀▒▒▒▒▄▀░░░"
#printf "\n░░░░░░▀▄▄▄▄▄▄▀▀▀▒▒▒▒▒▄▄▀░░░░░"
#printf "\n░░░░░░░░░▒▒▒▒▒▒▒▒▒▒▀▀░░░░░░░░"
#printf "\nMUCH PUU         VERY RESTFUL"

echo ""
echo ""
echo ""
echo ""
echo ""
echo ""
echo ""
echo ""
echo " [1m[38;5;65m                                                                                                                                wow[39m[0m"
echo ""
echo "[49m             [38;5;179m▄▄ [1m[38;5;74m                                                                                                         most data[39m[0m"
echo "             [48;5;179m [48;5;172m [49;38;5;172m▄                    [38;5;186m▄[38;5;179m▄[38;5;178m▄[38;5;172m▄ [1m[38;5;130m                                      very cyberark[39m[0m"
echo "             [48;5;179m [48;5;172m [48;5;136m [49m▄                 [38;5;187m▄[48;5;186;38;5;179m▄[48;5;179;38;5;142m▄[48;5;136m [38;5;130m▄[48;5;130;38;5;94m▄[48;5;179;38;5;136m▄[49m"
echo "             [48;5;179;38;5;178m▄[48;5;172m [48;5;136;38;5;130m▄[48;5;172m [48;5;179;38;5;172m▄[49;38;5;179m▄              ▄[48;5;179;38;5;136m▄[48;5;136m [48;5;137m▄[48;5;136m [48;5;130m   [49m"
echo "            [38;5;179m▄[48;5;178;38;5;136m▄[48;5;172m [48;5;136;38;5;178m▄▄[48;5;172m▄▄[48;5;179m▄[49m▄▄[38;5;179m▄▄      [38;5;186m▄[38;5;172m▄[48;5;178;38;5;136m▄[48;5;136;38;5;130m▄ ▄[48;5;130m [48;5;94m  [48;5;130m  [49m"
echo "           [38;5;179m▄[48;5;178m▄▄[48;5;179m   [48;5;178m  [38;5;172m▄     [38;5;179m▄  [38;5;172m▄[48;5;172;38;5;130m▄[38;5;136m▄[48;5;136;38;5;130m▄[48;5;94m [48;5;130;38;5;136m▄ [48;5;94;38;5;52m▄[48;5;88;38;5;233m▄[48;5;52m▄[48;5;88;38;5;94m▄[48;5;130m  [49m [1m[38;5;173m                                                    so csv[39m[0m"
echo "         [38;5;179m▄[38;5;185m▄[48;5;179m [38;5;186m▄[48;5;186m [48;5;179m▄  [48;5;178;38;5;172m▄[48;5;172m  [38;5;178m▄[48;5;178m  [48;5;179m ▄▄[48;5;178m   [48;5;172m▄[48;5;130;38;5;136m▄[48;5;88;38;5;130m▄[48;5;130m [48;5;136m ▄[48;5;94;38;5;232m▄[48;5;16m [48;5;233;38;5;52m▄[48;5;94;38;5;130m▄[48;5;136m [48;5;130;38;5;136m▄[49m [1m[38;5;95m                                         much restful[39m[0m"
echo "       [38;5;186m▄[48;5;186m [48;5;185m▄[48;5;179m  [48;5;186m   [48;5;179m [38;5;178m▄[48;5;172;38;5;136m▄ [48;5;178m [38;5;179m▄▄[48;5;179m  [48;5;142m▄[48;5;178m▄     [48;5;172m▄[48;5;130;38;5;172m▄[38;5;94m▄[48;5;52;38;5;16m▄[48;5;16m [38;5;52m▄[48;5;94;38;5;136m▄[48;5;136m   [49m"
echo "     [38;5;186m▄[48;5;186m  [38;5;179m▄[48;5;179;38;5;100m▄[48;5;186;38;5;94m▄[48;5;180;38;5;137m▄[38;5;179m▄[48;5;186;38;5;180m▄[48;5;180;38;5;179m▄[48;5;179;38;5;178m▄[48;5;172;38;5;136m▄[48;5;136m  [48;5;179m [38;5;186m▄[48;5;180m  [48;5;179m [48;5;143;38;5;179m▄[48;5;136m  [48;5;178;38;5;136m▄ [38;5;179m▄[48;5;179m  [48;5;178m▄[48;5;172;38;5;178m▄[48;5;94m▄[38;5;136m▄[48;5;130m▄[48;5;136m [48;5;94;38;5;130m▄[38;5;136m▄[49;38;5;172m▄"
echo "   [38;5;186m▄[48;5;186;38;5;223m▄[48;5;222;38;5;224m▄[48;5;223;38;5;230m▄[48;5;186;38;5;187m▄[48;5;137;38;5;144m▄[48;5;235;38;5;233m▄[48;5;16m  [48;5;137;38;5;136m▄[48;5;179m  [48;5;178;38;5;179m▄[48;5;172m▄[48;5;136m▄[48;5;179m [48;5;180m▄  [38;5;143m▄[48;5;179;38;5;137m▄  [48;5;172;38;5;178m▄[38;5;136m▄[48;5;178;38;5;172m▄ [38;5;179m▄[48;5;179m    [48;5;178m▄[48;5;172;38;5;178m▄[48;5;136m [48;5;130m [38;5;88m▄[48;5;136;38;5;130m▄[49m [1m[38;5;47m                so much program[39m[0m"
echo "   [48;5;186;38;5;187m▄[48;5;224;38;5;254m▄[48;5;254m [48;5;224;38;5;223m▄[48;5;187;38;5;186m▄[48;5;144;38;5;137m▄[48;5;16;38;5;58m▄▄[38;5;179m▄[48;5;179m      [38;5;172m▄[38;5;136m▄[48;5;143;38;5;52m▄[48;5;100;38;5;232m▄[48;5;58;38;5;244m▄[48;5;16m  [48;5;94;38;5;16m▄[48;5;136;38;5;94m▄[48;5;178;38;5;136m▄ [38;5;179m▄[48;5;179m      [38;5;178m▄[48;5;178m [48;5;130;38;5;172m▄[48;5;88;38;5;130m▄[48;5;130m [48;5;178;38;5;172m▄[49m"
echo "  [48;5;187m [48;5;223;38;5;224m▄[48;5;254m ▄[48;5;186m [48;5;179m [38;5;186m▄▄[38;5;185m▄ [38;5;186m▄▄[48;5;186m [38;5;179m▄[48;5;179m  [48;5;136;38;5;172m▄[48;5;58;38;5;136m▄[48;5;16m [48;5;59;38;5;232m▄[48;5;237;38;5;235m▄[48;5;16m  [38;5;58m▄[48;5;52;38;5;143m▄[48;5;136;38;5;179m▄[48;5;179m [38;5;180m▄▄      [48;5;178;38;5;179m▄ [48;5;136;38;5;172m▄▄[48;5;178m [49m"
echo " [38;5;187m▄[48;5;187;38;5;223m▄[48;5;254;38;5;253m▄[48;5;253m [48;5;187;38;5;224m▄[48;5;223;38;5;253m▄[48;5;222;38;5;144m▄[38;5;143m▄[48;5;186m▄[38;5;144m▄[38;5;180m▄[48;5;180m [48;5;186m   [48;5;179m  [48;5;178;38;5;179m▄▄[48;5;137m▄[48;5;94m▄[48;5;95;38;5;143m▄[48;5;58m▄[48;5;101;38;5;179m▄[48;5;143m▄[48;5;180m▄ [48;5;186;38;5;187m▄[48;5;187m [48;5;186m▄ [38;5;180m▄[48;5;180;38;5;186m▄[48;5;186m [48;5;180m▄ [48;5;179m [48;5;178;38;5;179m▄ [48;5;172;38;5;178m▄[48;5;178m [48;5;179m▄[49m"
echo "[38;5;180m▄[48;5;187m [48;5;223;38;5;187m▄[48;5;187m [38;5;230m▄[38;5;243m▄[48;5;238;38;5;16m▄[48;5;235m▄[48;5;236m▄[48;5;238m▄[48;5;235m▄[48;5;58m▄[48;5;144;38;5;233m▄[48;5;186;38;5;187m▄▄▄[48;5;180;38;5;186m▄[48;5;179;38;5;180m▄  [38;5;186m▄▄▄ [38;5;180m▄▄▄[48;5;186m [48;5;187m   [48;5;186;38;5;187m▄[48;5;180m▄[48;5;186m▄   [48;5;180m [48;5;179m  [48;5;178m [38;5;179m▄▄[48;5;180m▄[49m [1m[38;5;157m                                     such web scale[39m[0m"
echo "[48;5;180;38;5;187m▄[48;5;187;38;5;223m▄  [48;5;254;38;5;187m▄[48;5;102;38;5;241m▄[48;5;16m       [48;5;144;38;5;248m▄[48;5;187m  [48;5;186;38;5;187m▄ [48;5;180m [38;5;186m▄[48;5;186m [48;5;187m    [48;5;186;38;5;187m▄▄[48;5;187m  [38;5;186m▄▄▄▄[48;5;186m [38;5;180m▄▄▄[48;5;180m [38;5;179m▄[48;5;179;38;5;178m▄[48;5;178m  [38;5;179m▄[48;5;179m [49m [1m[38;5;70m               very much passwords[39m[0m"
echo "[48;5;187;38;5;186m▄   [48;5;250;38;5;144m▄[48;5;101;38;5;95m▄[48;5;16;38;5;232m▄    [38;5;238m▄[48;5;241;38;5;102m▄[48;5;145;38;5;144m▄[48;5;144m [38;5;180m▄[38;5;186m▄[48;5;180m [48;5;179m [48;5;180m [48;5;186;38;5;187m▄[48;5;187m  [38;5;186m▄    ▄▄▄[48;5;186;38;5;180m▄[48;5;180m [38;5;179m▄ ▄[48;5;179m   [48;5;172;38;5;136m▄[48;5;136;38;5;172m▄[48;5;178m  [48;5;179;38;5;178m▄ [49m"
echo "[48;5;186m [48;5;187m   [48;5;144m [48;5;59;38;5;95m▄[48;5;235;38;5;233m▄[48;5;16m  [38;5;232m▄▄[48;5;238;38;5;58m▄[48;5;102;38;5;101m▄[48;5;138;38;5;144m▄[48;5;144m [38;5;143m▄[48;5;179m▄  [48;5;180;38;5;179m▄    [48;5;186;38;5;180m▄▄[48;5;180m    [38;5;179m▄ [48;5;179;38;5;180m▄▄[48;5;180m  [38;5;179m▄[48;5;179m [48;5;178;38;5;142m▄[48;5;136m  [48;5;178m [38;5;136m▄ [49m [1m[38;5;159m                                                                                    beautiful doge[39m[0m"
echo "[48;5;186m [48;5;187m    [48;5;137;38;5;144m▄[48;5;16;38;5;58m▄     [48;5;94;38;5;16m▄[48;5;137;38;5;58m▄[48;5;143;38;5;101m▄▄[38;5;94m▄[38;5;58m▄[38;5;52m▄[48;5;137;38;5;58m▄[48;5;143m [48;5;180;38;5;143m▄ [38;5;179m▄[48;5;179m [38;5;180m▄[48;5;180m   [48;5;179m▄[48;5;180m [38;5;186m▄[48;5;186m  [48;5;180m▄ [38;5;179m▄[48;5;179m [48;5;178m [48;5;136;38;5;172m▄[48;5;178m▄[48;5;172m [38;5;178m▄[48;5;178m [49m"
echo " [48;5;187m   [48;5;186;38;5;187m▄ [48;5;143;38;5;180m▄[48;5;58;38;5;137m▄[48;5;232;38;5;94m▄[48;5;16m▄▄▄▄[38;5;58m▄▄[48;5;232;38;5;94m▄[48;5;16m▄[48;5;232;38;5;100m▄[48;5;58;38;5;136m▄[48;5;101;38;5;143m▄[48;5;143;38;5;180m▄[48;5;179m▄  [48;5;180m          [38;5;179m▄▄[48;5;179m [48;5;178;38;5;172m▄[48;5;136m  [48;5;172;38;5;136m▄[48;5;136m [48;5;172m▄[49m"
echo "[38;5;223m▄[48;5;223m [48;5;187m  [38;5;186m▄[48;5;186m  [48;5;180m▄[48;5;137;38;5;180m▄[48;5;100;38;5;179m▄[48;5;137m▄▄[48;5;143m▄[48;5;137m▄▄[48;5;136m▄[48;5;137m▄[48;5;143m▄[48;5;179m        [48;5;180m[38;5;186m▄  [38;5;179m▄▄[48;5;179m [38;5;178m▄[48;5;178;38;5;172m▄[48;5;172;38;5;136m▄[48;5;178;38;5;172m▄[48;5;136m▄  [49m [1m[38;5;171m                                                                          wow[39m[0m"
echo " [48;5;223m  [48;5;187;38;5;186m▄▄[48;5;186m   [38;5;180m▄▄[48;5;179m        [48;5;143;38;5;179m▄▄[48;5;179;38;5;143m▄[48;5;143;38;5;179m▄[48;5;179m [38;5;180m▄[48;5;180m    [48;5;186m▄[48;5;180m  [38;5;179m▄[48;5;179m  [38;5;178m▄[48;5;172m▄[48;5;136;38;5;172m▄[48;5;172;38;5;136m▄▄[48;5;136;38;5;130m▄ [49m"
echo "  [38;5;223m▀[48;5;186m [38;5;179m▄[38;5;180m▄  [48;5;180m [38;5;179m▄[48;5;179m  [48;5;180m▄[48;5;179m   [48;5;143m▄[48;5;179m      [48;5;180m   [48;5;186;38;5;180m▄[48;5;180m [38;5;179m▄[48;5;179m [38;5;180m▄   [48;5;178;38;5;179m▄ [48;5;136;38;5;172m▄  [48;5;130;38;5;136m▄[49m▀"
echo "    [38;5;180m▀[48;5;179;38;5;185m▄  [48;5;180;38;5;179m▄[48;5;179m           [48;5;143m▄[48;5;179m  [48;5;180m▄[48;5;179;38;5;143m▄[48;5;180;38;5;179m▄[48;5;179m   [38;5;180m▄[48;5;180;38;5;179m▄[48;5;179m    [48;5;178m [48;5;136;38;5;172m▄  [49m"
echo "      [38;5;179m▀▀[48;5;179m    [38;5;142m▄  ▄[38;5;136m▄[38;5;142m▄[48;5;143m▄▄▄[38;5;136m▄ [38;5;142m▄[48;5;136;38;5;143m▄[48;5;143m [48;5;179;38;5;180m▄         [49;38;5;178m▀▀"
echo "            [38;5;136m▀▀[38;5;142m▀[38;5;136m▀▀▀▀▀[38;5;143m▀▀▀[38;5;179m▀[38;5;180m▀▀[39m"
echo ""

printf "\n\n"


read -p "Enter the CyberArk URL (ie: https://components.cyberark.local) : " CAURL
read -p "Enter Your Name: " CAUsername
read -s -p "Enter Password: " CAPass
printf "\n"
read -p "Enter the path of the CSV file (ie: /home/user/cyberark.csv): " INPUT

printf "\n"
#login and get auth_key
curl --insecure -s -i -H "Accept: application/json" -H "Content-Type:application/json" -X POST --data '{"username":"'"$CAUsername"'", "password":"'"$CAPass"'"}' $CAURL/PasswordVault/WebServices/auth/Cyberark/CyberArkAuthenticationService.svc/Logon | sed -e ':a;N;$!ba;s/\n/ /g' | sed -e 's/.*\"\:\"\(.*\)\"}.*/\1/g' > auth.key

#add "authorization:" to head of file
sed -i '1s/^/authorization: /' ./auth.key

#set auth_key
AUTH=$(cat ./auth.key)
printf "\n--------------------------------------------------"
printf "\n\nYour CyberArk RestAPI Auth Token:\n\n"
echo "$AUTH"
printf "\n--------------------------------------------------\n\n"

#Process the file
OLDIFS=$IFS
IFS=,
[ ! -f $INPUT ] && { echo "$INPUT file not found"; exit 99; }

while read CYBRObjectName CYBRSafe CYBRAddress CYBRUsername CYBRPassword CYBRPlatformID CYBRDisableAutoMgmt CYBRDisableAutoMgmtReason
do
	echo "ObjectName : $CYBRObjectName"
	echo "Safe : $CYBRSafe"
	echo "Address : $CYBRAddress"
	echo "Username : $CYBRUsername"
	echo "Password : $CYBRPassword"
	echo "PlatformID : $CYBRPlatformID"
	echo "DisableAutoMgmt : $CYBRDisableAutoMgmt"
	echo "DisableAutoMgmtReason : $CYBRDisableAutoMgmtReason"

printf "\n--------------------------------------------------\n\n"
printf "Attempting to create your account.  Logs below:\n"
printf "\n--------------------------------------------------\n\n"

curl --insecure -s -i -H "$AUTH" -H "Content-Type:application/json" -X POST --data '{"account" : {"safe":"'"$CYBRSafe"'","platformID": "'"$CYBRPlatformID"'","address": "'"$CYBRAddress"'","accountName": "'"$CYBRObjectName"'","password": "'"CYBRPassword"'","username": "'"$CYBRUsername"'",}}' $CAURL/PasswordVault/WebServices/PIMServices.svc/Account | grep HTTP/1.1


done < $INPUT
IFS=$OLDIFS

#logoff_from_safe
curl --insecure -s -i -H "$AUTH" -d -H "Content-Type:application/json" -X POST $CAURL/PasswordVault/WebServices/auth/Cyberark/CyberArkAuthenticationService.svc/Logoff| grep HTTP/1.1
printf "\nLogged off\n"

# A little cleanup is needed
rm -rf ./auth.key
